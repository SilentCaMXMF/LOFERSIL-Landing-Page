name: Deploy to Vercel (Bun Support)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Vercel
    strategy:
      matrix:
        runtime: [npm, bun]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.runtime == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Bun
        if: matrix.runtime == 'bun'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies (npm)
        if: matrix.runtime == 'npm'
        run: npm ci

      - name: Install dependencies (bun)
        if: matrix.runtime == 'bun'
        run: bun install --frozen-lockfile

      - name: Audit dependencies (npm)
        if: matrix.runtime == 'npm'
        run: npm audit --audit-level=high

      - name: Audit dependencies (bun)
        if: matrix.runtime == 'bun'
        run: bun audit

      - name: Run tests (npm)
        if: matrix.runtime == 'npm'
        run: npm run lint

      - name: Run tests (bun)
        if: matrix.runtime == 'bun'
        run: bun run lint:bun

       - name: Build project (npm)
         if: matrix.runtime == 'npm'
         run: npm run build
         env:
           NODE_ENV: production
           # Deployment
           WEBSITE_URL: ${{ secrets.WEBSITE_URL }}
           # AI API Keys
           GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
           CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
           # Email Configuration
           SMTP_HOST: ${{ secrets.SMTP_HOST }}
           SMTP_PORT: ${{ secrets.SMTP_PORT }}
           SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
           SMTP_USER: ${{ secrets.SMTP_USER }}
           SMTP_PASS: ${{ secrets.SMTP_PASS }}
           FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
           TO_EMAIL: ${{ secrets.TO_EMAIL }}
           ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
           # Analytics & Monitoring
           GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
           HOTJAR_ID: ${{ secrets.HOTJAR_ID }}
           SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
           # Telegram Bot
           TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
           TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
           TELEGRAM_BOT_USERNAME: ${{ secrets.TELEGRAM_BOT_USERNAME }}
           TELEGRAM_TEST_CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
           # Application Configuration
           CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
           PHONE_NUMBER: ${{ secrets.PHONE_NUMBER }}
           COMPANY_NAME: ${{ secrets.COMPANY_NAME }}
           COMPANY_DESCRIPTION: ${{ secrets.COMPANY_DESCRIPTION }}
           SITE_NAME: ${{ secrets.SITE_NAME }}
           SITE_TITLE: ${{ secrets.SITE_TITLE }}
           SITE_DESCRIPTION: ${{ secrets.SITE_DESCRIPTION }}
           OG_IMAGE_URL: ${{ secrets.OG_IMAGE_URL }}
           # Feature Flags
           ENABLE_ANALYTICS: ${{ secrets.ENABLE_ANALYTICS }}
           ENABLE_ERROR_TRACKING: ${{ secrets.ENABLE_ERROR_TRACKING }}
           ENABLE_PERFORMANCE_MONITORING: ${{ secrets.ENABLE_PERFORMANCE_MONITORING }}
           ENABLE_MCP_INTEGRATION: ${{ secrets.ENABLE_MCP_INTEGRATION }}
           # MCP Configuration
           MCP_API_KEY: ${{ secrets.MCP_API_KEY }}
           MCP_SERVER_URL: ${{ secrets.MCP_SERVER_URL }}
           MCP_CLIENT_ID: ${{ secrets.MCP_CLIENT_ID }}
           MCP_RECONNECT_INTERVAL: ${{ secrets.MCP_RECONNECT_INTERVAL }}
           MCP_MAX_RECONNECT_ATTEMPTS: ${{ secrets.MCP_MAX_RECONNECT_ATTEMPTS }}

       - name: Build project (bun)
         if: matrix.runtime == 'bun'
         run: bun run build:bun
         env:
           NODE_ENV: production
           # Deployment
           WEBSITE_URL: ${{ secrets.WEBSITE_URL }}
           # AI API Keys
           GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
           CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
           # Email Configuration
           SMTP_HOST: ${{ secrets.SMTP_HOST }}
           SMTP_PORT: ${{ secrets.SMTP_PORT }}
           SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
           SMTP_USER: ${{ secrets.SMTP_USER }}
           SMTP_PASS: ${{ secrets.SMTP_PASS }}
           FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
           TO_EMAIL: ${{ secrets.TO_EMAIL }}
           ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
           # Analytics & Monitoring
           GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
           HOTJAR_ID: ${{ secrets.HOTJAR_ID }}
           SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
           # Telegram Bot
           TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
           TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
           TELEGRAM_BOT_USERNAME: ${{ secrets.TELEGRAM_BOT_USERNAME }}
           TELEGRAM_TEST_CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
           # Application Configuration
           CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
           PHONE_NUMBER: ${{ secrets.PHONE_NUMBER }}
           COMPANY_NAME: ${{ secrets.COMPANY_NAME }}
           COMPANY_DESCRIPTION: ${{ secrets.COMPANY_DESCRIPTION }}
           SITE_NAME: ${{ secrets.SITE_NAME }}
           SITE_TITLE: ${{ secrets.SITE_TITLE }}
           SITE_DESCRIPTION: ${{ secrets.SITE_DESCRIPTION }}
           OG_IMAGE_URL: ${{ secrets.OG_IMAGE_URL }}
           # Feature Flags
           ENABLE_ANALYTICS: ${{ secrets.ENABLE_ANALYTICS }}
           ENABLE_ERROR_TRACKING: ${{ secrets.ENABLE_ERROR_TRACKING }}
           ENABLE_PERFORMANCE_MONITORING: ${{ secrets.ENABLE_PERFORMANCE_MONITORING }}
           ENABLE_MCP_INTEGRATION: ${{ secrets.ENABLE_MCP_INTEGRATION }}
           # MCP Configuration
           MCP_API_KEY: ${{ secrets.MCP_API_KEY }}
           MCP_SERVER_URL: ${{ secrets.MCP_SERVER_URL }}
           MCP_CLIENT_ID: ${{ secrets.MCP_CLIENT_ID }}
           MCP_RECONNECT_INTERVAL: ${{ secrets.MCP_RECONNECT_INTERVAL }}
           MCP_MAX_RECONNECT_ATTEMPTS: ${{ secrets.MCP_MAX_RECONNECT_ATTEMPTS }}

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && '--prod' || '' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR
        if: github.event_name == 'pull_request' && matrix.runtime == 'npm'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ðŸš€ Preview')
            );

            if (botComment) {
               await github.rest.issues.updateComment({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 comment_id: botComment.id,
                 body: `ðŸš€ Preview deployment is ready! (npm build)

                 **Preview URL:** ${{ steps.deploy.outputs.preview-url }}

                 This preview will be updated on each push to this PR.

                 ---

                 *This comment was automatically generated by deployment workflow.*`
               });
            } else {
               await github.rest.issues.createComment({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 issue_number: context.issue.number,
                 body: `ðŸš€ Preview deployment is ready! (npm build)

                 **Preview URL:** ${{ steps.deploy.outputs.preview-url }}

                 This preview will be updated on each push to this PR.

                 ---

                 *This comment was automatically generated by deployment workflow.*`
                });
              }

      - name: Create GitHub Deployment
        id: create-deployment
        if: github.event_name == 'push' && matrix.runtime == 'npm'
        uses: actions/github-script@v7
        env:
          PRODUCTION_URL: ${{ steps.deploy.outputs.production-url }}
          PREVIEW_URL: ${{ steps.deploy.outputs.preview-url }}
        with:
          script: |
            const core = require('@actions/core');
            try {
              const isProduction = process.env.GITHUB_REF === 'refs/heads/main';
              const environment = isProduction ? 'production' : 'preview';
              const deploymentUrl = isProduction ? process.env.PRODUCTION_URL : process.env.PREVIEW_URL;

              const { data: deployment } = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: environment,
                description: 'Deploy to Vercel (npm)',
                required_contexts: []
              });

              core.setOutput('deployment-id', deployment.id);
              core.setOutput('deployment-url', deploymentUrl);
              core.setOutput('environment', environment);
            } catch (error) {
              core.setFailed(`Failed to create deployment: ${error.message}`);
            }

      - name: Update deployment status
        if: github.event_name == 'push' && matrix.runtime == 'npm'
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            try {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: '${{ steps.create-deployment.outputs.deployment-id }}',
                state: 'success',
                target_url: '${{ steps.create-deployment.outputs.deployment-url }}',
                description: 'Deployment completed successfully (npm)'
              });
            } catch (error) {
              core.setFailed(`Failed to update deployment status: ${error.message}`);
            }
