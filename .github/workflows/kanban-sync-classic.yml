name: Sync Kanban to GitHub Project (Beta v2)

on:
  workflow_dispatch:
  push:
    paths:
      - kanban_payload.json

permissions:
  contents: write

jobs:
  kanban-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Kanban Payload to Projects v2
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.KANBAN_GH_TOKEN }}
          script: |
            const fs = require('fs');
            const payload = JSON.parse(fs.readFileSync('kanban_payload.json','utf8'));
            const tasks = payload.tasks;

            // Target: Projects v2 (Beta) - user: SilentCaMXMF, project number 2
            const USER_LOGIN = 'SilentCaMXMF';
            const PROJECT_NUMBER = 2;
            // Issues will be created in the LOFERSIL-Landing-Page repo (owned by USER_LOGIN)
            const ISSUES_REPO_OWNER = USER_LOGIN;
            const ISSUES_REPO = 'LOFERSIL-Landing-Page';

            // 1) Get the user projects v2 and pick the one with number = PROJECT_NUMBER
            const getUserProjects = `
              query($login:String!) {
                user(login: $login) {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      number
                      title
                    }
                  }
                }
              }
            `;
            const projectsResp = await github.graphql(getUserProjects, { login: USER_LOGIN });
            const targetProject = projectsResp.user.projectsV2.nodes.find(p => p.number === PROJECT_NUMBER);
            if (!targetProject) {
              core.setFailed(`Could not locate user project number ${PROJECT_NUMBER} for ${USER_LOGIN}`);
              return;
            }
            const projectId = targetProject.id;

            // 2) Get project fields (columns/statuses) - assuming single-select field for status
            const getProjectFields = `
              query($projectId:ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            const fieldsResp = await github.graphql(getProjectFields, { projectId });
            const statusField = fieldsResp.node.fields.nodes.find(f => f.name && f.name.toLowerCase() === 'status');
            if (!statusField) {
              core.setFailed('Could not find Status field in the project');
              return;
            }
            const statusOptions = {};
            for (const opt of statusField.options) {
              statusOptions[opt.name.toLowerCase()] = opt.id;
            }

             // Mapping from group to status option name (matches your project's column names)
             function mapGroupToStatusId(group) {
               const g = (group || '').toLowerCase().trim();
               const mapping = {
                 'completed': 'In review',  // Completed tasks go to In review
                 'done': 'In review',
                 'ongoing': 'In progress',
                 'in progress': 'In progress',
                 'inprogress': 'In progress',
                 'todo': 'Backlog',
                 'to do': 'Backlog',
                 'plans': 'Ready',
                 'subtasks': 'Ready'
               };
               const targetName = mapping[g] || 'Backlog'; // Default to Backlog if no match
               return statusOptions[targetName] || Object.values(statusOptions)[0];
             }

            // 3) For each task: create an issue, then add to project with status
            async function createIssueForTask(t) {
              const body = [
                `Group: ${t.group}`,
                `Status: ${t.status}`,
                `Source: ${t.source}`,
                `Notes: ${t.notes}`,
                `KanbanID: ${t.id}`
              ].join('\\n');
              const issue = await github.rest.issues.create({
                owner: ISSUES_REPO_OWNER,
                repo: ISSUES_REPO,
                title: t.title,
                body: body
              });
              return issue.data.node_id; // GraphQL node_id for adding to project
            }

            for (const t of tasks) {
              // Create the issue
              const issueNodeId = await createIssueForTask(t);

               // Resolve status option
               const statusOptionId = mapGroupToStatusId(t.group);

               // Add issue to project
               const addItemMutation = `
                 mutation($projectId:ID!, $contentId:ID!) {
                   addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                     item {
                       id
                     }
                   }
                 }
               `;
               const addItemResp = await github.graphql(addItemMutation, {
                 projectId,
                 contentId: issueNodeId
               });
               const itemId = addItemResp.addProjectV2ItemById.item.id;

               // Set status field
               const updateStatusMutation = `
                 mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!) {
                   updateProjectV2ItemFieldValue(input: {
                     projectId: $projectId,
                     itemId: $itemId,
                     fieldId: $fieldId,
                     value: { singleSelectOptionId: $optionId }
                   }) {
                     projectV2Item {
                       id
                     }
                   }
                 }
               `;
               await github.graphql(updateStatusMutation, {
                 projectId,
                 itemId,
                 fieldId: statusField.id,
                 optionId: statusOptionId
               });

               core.info(`Added issue "${t.title}" to project with status: ${statusOptionId}`);
            }

            core.info('Kanban sync completed.');
