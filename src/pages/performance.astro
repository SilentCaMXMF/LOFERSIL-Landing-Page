---
import MainLayout from '../layouts/MainLayout.astro';

const title = "Performance Testing - LOFERSIL";
const description = "Performance testing dashboard for LOFERSIL landing page with Web Vitals monitoring.";

const alternate = {
  'en': '/en/performance.html',
};
---

<MainLayout title={title} description={description} lang="pt" alternate={alternate}>
  <main class="performance-dashboard">
    <div class="container">
      <h1>Performance Testing Dashboard</h1>
      <p class="dashboard-intro">
        This dashboard shows real-time performance metrics and testing tools for the LOFERSIL landing page.
      </p>

      <div class="metrics-grid">
        <section class="metric-card">
          <h2>üöÄ Core Web Vitals</h2>
          <div id="web-vitals" class="metrics-display">
            <div class="metric-item">
              <span class="metric-label">First Contentful Paint (FCP):</span>
              <span id="fcp-value" class="metric-value">--</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Largest Contentful Paint (LCP):</span>
              <span id="lcp-value" class="metric-value">--</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">First Input Delay (FID):</span>
              <span id="fid-value" class="metric-value">--</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Cumulative Layout Shift (CLS):</span>
              <span id="cls-value" class="metric-value">--</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Time to First Byte (TTFB):</span>
              <span id="ttfb-value" class="metric-value">--</span>
            </div>
          </div>
        </section>

        <section class="metric-card">
          <h2>üìä Performance Score</h2>
          <div class="score-display">
            <div id="overall-score" class="score-circle">
              <span class="score-number">--</span>
              <span class="score-label">Overall</span>
            </div>
            <div class="score-breakdown">
              <div class="score-item good">
                <span>Good: <span id="score-good">0</span></span>
              </div>
              <div class="score-item needs-improvement">
                <span>Needs Improvement: <span id="score-needs">0</span></span>
              </div>
              <div class="score-item poor">
                <span>Poor: <span id="score-poor">0</span></span>
              </div>
            </div>
          </div>
        </section>

        <section class="metric-card">
          <h2>‚ö†Ô∏è Error Tracking</h2>
          <div id="error-tracking" class="error-display">
            <div class="metric-item">
              <span class="metric-label">JavaScript Errors:</span>
              <span id="js-errors" class="metric-value">0</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Network Errors:</span>
              <span id="network-errors" class="metric-value">0</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Performance Issues:</span>
              <span id="perf-issues" class="metric-value">0</span>
            </div>
          </div>
        </section>

        <section class="metric-card">
          <h2>üõ† Testing Tools</h2>
          <div class="testing-tools">
            <button id="test-load-time" class="test-btn">
              Test Load Time
            </button>
            <button id="test-memory" class="test-btn">
              Test Memory Usage
            </button>
            <button id="test-cache" class="test-btn">
              Test Cache Performance
            </button>
            <button id="clear-cache" class="test-btn">
              Clear Cache
            </button>
          </div>
          <div id="test-results" class="test-results">
            <!-- Test results will appear here -->
          </div>
        </section>
      </div>

      <section class="recommendations-card">
        <h2>üí° Performance Recommendations</h2>
        <div id="recommendations" class="recommendations-list">
          <!-- Recommendations will appear here -->
        </div>
      </section>
    </div>
  </main>

  <script>
    // Performance Dashboard Script
    class PerformanceDashboard {
      constructor() {
        this.initialize();
      }

      initialize() {
        this.setupEventListeners();
        this.startMonitoring();
        this.runTests();
      }

      setupEventListeners() {
        document.getElementById('test-load-time')?.addEventListener('click', () => this.testLoadTime());
        document.getElementById('test-memory')?.addEventListener('click', () => this.testMemoryUsage());
        document.getElementById('test-cache')?.addEventListener('click', () => this.testCachePerformance());
        document.getElementById('clear-cache')?.addEventListener('click', () => this.clearCache());
      }

      startMonitoring() {
        // Listen for performance updates from main app
        window.addEventListener('performanceUpdate', (event) => {
          this.updateMetrics(event.detail);
        });

        // Start periodic updates
        setInterval(() => this.updateDisplay(), 1000);
      }

      updateMetrics(metrics) {
        if (metrics.fcp) document.getElementById('fcp-value').textContent = `${Math.round(metrics.fcp)}ms`;
        if (metrics.lcp) document.getElementById('lcp-value').textContent = `${Math.round(metrics.lcp)}ms`;
        if (metrics.fid) document.getElementById('fid-value').textContent = `${Math.round(metrics.fid)}ms`;
        if (metrics.cls) document.getElementById('cls-value').textContent = metrics.cls.toFixed(3);
        if (metrics.ttfb) document.getElementById('ttfb-value').textContent = `${Math.round(metrics.ttfb)}ms`;
      }

      updateDisplay() {
        // Update score if available
        if (window.lofersilAnalytics) {
          const stats = window.lofersilAnalytics.getSessionInfo();
          this.updateErrorCount();
        }
      }

      updateErrorCount() {
        if (window.lofersilErrorTracker) {
          const stats = window.lofersilErrorTracker.getStats();
          document.getElementById('js-errors').textContent = stats.errorCount;
        }
      }

      async testLoadTime() {
        const startTime = performance.now();
        this.showTestResult('Testing load time...', 'info');
        
        try {
          const response = await fetch(window.location.href, { cache: 'no-store' });
          const endTime = performance.now();
          const loadTime = Math.round(endTime - startTime);
          
          this.showTestResult(`Load time: ${loadTime}ms`, 
                           loadTime < 1000 ? 'success' : 
                           loadTime < 3000 ? 'warning' : 'error');
        } catch (error) {
          this.showTestResult(`Load test failed: ${error.message}`, 'error');
        }
      }

      testMemoryUsage() {
        if (performance.memory) {
          const memory = performance.memory;
          const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
          const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
          const limit = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);
          
          this.showTestResult(`Memory: ${used}MB / ${total}MB (Limit: ${limit}MB)`,
                           used < 50 ? 'success' : used < 100 ? 'warning' : 'error');
        } else {
          this.showTestResult('Memory API not available', 'warning');
        }
      }

      async testCachePerformance() {
        try {
          const cache = await caches.open('test-cache');
          const testData = { timestamp: Date.now() };
          
          // Test cache write
          const writeStart = performance.now();
          await cache.put('/test', new Response(JSON.stringify(testData)));
          const writeTime = performance.now() - writeStart;
          
          // Test cache read
          const readStart = performance.now();
          const cached = await cache.match('/test');
          const readTime = performance.now() - readStart;
          
          this.showTestResult(`Cache write: ${Math.round(writeTime)}ms, read: ${Math.round(readTime)}ms`,
                           writeTime < 10 && readTime < 5 ? 'success' : 'warning');
          
          await cache.delete('/test');
        } catch (error) {
          this.showTestResult(`Cache test failed: ${error.message}`, 'error');
        }
      }

      async clearCache() {
        try {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'CACHE_UPDATE' });
          }
          
          this.showTestResult('All caches cleared', 'success');
        } catch (error) {
          this.showTestResult(`Cache clear failed: ${error.message}`, 'error');
        }
      }

      showTestResult(message, type = 'info') {
        const results = document.getElementById('test-results');
        const result = document.createElement('div');
        result.className = `test-result test-${type}`;
        result.innerHTML = `
          <span class="test-time">${new Date().toLocaleTimeString()}</span>
          <span class="test-message">${message}</span>
        `;
        
        results.insertBefore(result, results.firstChild);
        
        // Keep only last 5 results
        while (results.children.length > 5) {
          results.removeChild(results.lastChild);
        }
      }

      async runTests() {
        // Run initial tests after page loads
        setTimeout(() => {
          this.testLoadTime();
          this.testMemoryUsage();
          this.testCachePerformance();
        }, 2000);
      }
    }

    // Initialize dashboard when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new PerformanceDashboard());
    } else {
      new PerformanceDashboard();
    }
  </script>

  <style>
    .performance-dashboard {
      padding: 2rem 0;
      background: #f8f9fa;
      min-height: 100vh;
    }

    .dashboard-intro {
      text-align: center;
      max-width: 800px;
      margin: 0 auto 3rem;
      color: #666;
      font-size: 1.1rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .metric-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-card h2 {
      margin-top: 0;
      color: #0366d6;
    }

    .metric-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }

    .metric-item:last-child {
      border-bottom: none;
    }

    .metric-value {
      font-weight: bold;
      color: #0366d6;
    }

    .score-display {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .score-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .score-number {
      font-size: 2rem;
      font-weight: bold;
    }

    .score-label {
      font-size: 0.8rem;
      color: #666;
    }

    .testing-tools {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .test-btn {
      padding: 0.75rem 1rem;
      border: 1px solid #0366d6;
      background: white;
      color: #0366d6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .test-btn:hover {
      background: #0366d6;
      color: white;
    }

    .test-results {
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .test-result {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .test-success { background: #d4edda; color: #155724; }
    .test-warning { background: #fff3cd; color: #856404; }
    .test-error { background: #f8d7da; color: #721c24; }
    .test-info { background: #d1ecf1; color: #0c5460; }

    .recommendations-card {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .recommendations-list {
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      .testing-tools {
        grid-template-columns: 1fr;
      }
      
      .score-display {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</MainLayout>